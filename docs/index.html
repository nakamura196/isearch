<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>IIIF Collection Search</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

  <script type="text/javascript" src="itemsjs.js"></script>

  <script type="text/javascript" src="https://cdn.jsdelivr.net/vue/latest/vue.js"></script>

  <script type="text/javascript" src="https://unpkg.com/vuejs-paginate@latest"></script>


  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">

  <link href="normalize.css" rel="stylesheet">

  <!-- Bootstrap core CSS -->
  <link href="style.css" rel="stylesheet">

  <style>
    a {
      text-decoration: none !important;
    }
  </style>

  <!-- TODO: Missing CoffeeScript 2 -->

  <script type="text/javascript">//<![CDATA[

    var url = getParam('u') ? getParam('u') : null;

    if(!url){
      location.href = "https://github.com/nakamura196/isearch/"
    }

    var filters = getParam('filters') ? JSON.parse(getParam('filters')) : {};
    var q = getParam('q') ? getParam('q') : "";

    //var page = getParam('page') ? Number(getParam('page')) : 1;
    var page = 1;
    var per_page = getParam('per_page') ? Number(getParam('per_page')) : 20;
    var sort = getParam('sort') ? getParam('sort') : "_score_desc";
    var grid = getParam('grid') == "false" ? false : true;

    window.onload = function () {

      var req = new XMLHttpRequest();						// XMLHttpRequest オブジェクトを生成する
      req.onreadystatechange = function () {				// XMLHttpRequest オブジェクトの状態が変化した際に呼び出されるイベントハンドラ
        if (req.readyState == 4 && req.status == 200) {	// サーバーからのレスポンスが完了し、かつ、通信が正常に終了した場合

          var data = JSON.parse(req.responseText);	// 取得した JSON ファイルの中身を変数へ格納
          main(data)

        }
      };
      req.open("GET", url, false);				// HTTPメソッドとアクセスするサーバーのURLを指定
      req.send(null);
    }

    function main(data) {
      var configuration = data.config

      var rows = data.rows

      // the rows comes from external resources
      // https://github.com/itemsapi/itemsapi-example-data/blob/master/jsfiddle/imdb.js
      itemsjs = itemsjs(rows, configuration);

      // add vue component for pagination
      Vue.component('paginate', VuejsPaginate)

      var vm = new Vue({
        el: '#el',
        data: function () {

          // making it more generic
          if (Object.keys(filters).length == 0) {
            Object.keys(configuration.aggregations).map(function (v) {
              filters[v] = [];
            })
          }

          label = configuration.label ? configuration.label : "IIIF Collection Search";
          footer = configuration.footer ? configuration.footer : "IIIF Collection Search developed by Minimal Archive Project.";

          return {
            sortings: configuration.sortings,
            query: q,
            // initializing filters with empty arrays
            sort: sort,
            filters: filters,
            page: page,
            per_page: per_page,
            label: label,
            footer: footer,
            grid: grid
          }
        },
        methods: {
          goToPage: function (page) {
            this.page = page;
            return page;
          },
          active: function () {
            this.grid = !this.grid
          }
        },
        computed: {
          searchResult: function () {

            history.replaceState('', '', '?u=' + url + '&q=' + this.query + "&filters=" + JSON.stringify(this.filters) + "&sort=" + this.sort + "&page=" + this.page + "&per_page=" + this.per_page + "&grid=" + this.grid);

            var result = itemsjs.search({
              query: this.query,
              sort: this.sort,
              page: this.page,
              per_page: this.per_page,
              filters: this.filters,
              grid: this.grid
            })

            return result
          }
        }
      });
    }

    /**
   * Get the URL parameter value
   *
   * @param  name {string} パラメータのキー文字列
   * @return  url {url} 対象のURL文字列（任意）
   */
    function getParam(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, "\\$&");
      var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

  //]]></script>

</head>

<body style="background: #f7f7f7;">
  <div id="el">

    <!--Navbar-->
    <nav class="navbar navbar-dark bg-dark navbar-expand-lg fixed-top">

      <div class="container-fluid">

        <!-- Navbar brand -->
        <span class="navbar-brand white-text mr-4">{{label}}</span>

        <div style="width: 100%">
          <input type="text" v-model="query" class="form-control" placeholder="Search">
        </div>

      </div>

    </nav>
    <!--/.Navbar-->

    <div class="py-5" style="margin-top: 60px;">

      <div class="container-fluid">


        <div class="row">



          <div class="col-md-9 order-md-2 order-sm-1 mb-4">

            <!-- Card Light -->
            <div>

              <!-- Card content -->
              <div>

                <div class="row mb-4">

                  <div class="col-md-4">
                    {{ searchResult.pagination.total }} results found
                  </div>

                  <div class="col-md-8">


                    <div class="form-inline float-sm-right">
                      <div class="btn-group btn-group-toggle mx-1 py-1" data-toggle="buttons" @click="active">
                        <label class="mx-2">
                          <i class="fas fa-th-large"></i>
                        </label>
                        <label class="mx-2">
                          <i class="fas fa-th-list"></i>
                        </label>
                      </div>

                      <div class="form-group mx-1 py-1">
                        <select v-model="per_page" class="form-control">
                          <option value=20>20</option>
                          <option value=50>50</option>
                          <option value=100>100</option>
                        </select>
                      </div>

                      <div class="form-group mx-1 py-1">
                        <select v-model="sort" class="form-control">
                          <option value="_score_desc">Relevance</option>
                          <option v-for="(value, key) in sortings" :value="key">{{key}}</option>
                        </select>
                      </div>
                    </div>


                  </div>


                </div>

                <div class="row" v-if="grid">
                  <template v-for="item of searchResult.data.items">

                    <div class="col-lg-3 col-md-4 mb-4">

                      <div class="card">
                        <a :href="item._related" target="related">
                          <img width="100%" class="img-responsive mb-2" v-bind:src="item._thumbnail">
                        </a>
                        <div class="card-body">

                          <b><a class="text-body" :href="item._related" target="related">{{ item._label }}</a></b>

                        </div>

                      </div>

                    </div>


                  </template>
                </div>

                <template v-for="item of searchResult.data.items" v-else>



                  <div class="card mb-4">
                    <div class="card-body">

                      <div class="row">


                        <div class="col-md-2 mb-2">
                          <div class="px-1">
                            <a :href="item._related" target="related">
                              <img width="100%" class="img-responsive" v-bind:src="item._thumbnail">
                            </a>
                          </div>
                        </div>
                        <div class="col-md-10">

                          <p><b><a class="text-body" :href="item._related" target="related">{{ item._label }}</a></b>
                          </p>
                          <p>
                            {{ item._description }}
                          </p>
                          <p>
                            <template v-for="(array, field) in item" v-if="Array.isArray(array)">
                              <b>{{ field }}:</b> <span v-for="tag in array">{{ tag }}&nbsp;</span>&nbsp;&nbsp;

                            </template>
                          </p>

                        </div>
                      </div>
                    </div>
                  </div>




                </template>

                <!-- div for pagination block -->
                <div class="mt-5">
                  <paginate style="justify-content: center;"
                    :page-count="Math.ceil(searchResult.pagination.total / searchResult.pagination.per_page)"
                    :click-handler="goToPage" :prev-text="'&laquo;'" :next-text="'&raquo;'"
                    :container-class="'pagination'" :page-class="'page-item'" :page-link-class="'page-link'"
                    :prev-class="'page-item'" :prev-link-class="'page-link'" :next-class="'page-item'"
                    :next-link-class="'page-link'">
                  </paginate>
                </div>

              </div>
            </div>

          </div>



          <div class="col-md-3 order-md-1 order-sm-2">

            <!-- Card Light -->
            <div>

              <!-- Card content -->
              <div>
                <div class="mb-4 card" v-for="facet in searchResult.data.aggregations" v-if="facet.buckets.length > 0">
                  <div class="card-body">
                    <h5><strong>{{ facet.title }}</strong></h5>

                    <ul class="browse-list list-unstyled long-list" style="margin-bottom: 0;">
                      <li v-for="bucket in facet.buckets">
                        <div class="checkbox block">
                          <label>
                            <input class="checkbox" type="checkbox" v-model="filters[facet.name]"
                              v-bind:value="bucket.key">
                            {{ bucket.key }} <small class="text-muted">({{ bucket.doc_count }})</small>
                          </label>
                        </div>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <hr />

        <footer>

          <div class="containter-fluid my-5 text-center">
            {{footer}}
          </div>
        </footer>

      </div>
    </div>
  </div>

</body>

</html>